name: Update Zee5 Playlist

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Fetch Zee5 Token
        id: fetch
        run: |
          echo "Fetching Zee Bangla URL..."
          RAW=$(curl -s -L -A "Mozilla/5.0" "http://mini.allinonereborn.fun/zee-paid/index.php?id=0-9-zeebangla")

          echo "--------------- RAW ---------------"
          echo "$RAW"
          echo "-----------------------------------"

          echo "$RAW" > raw_debug.txt

          # Extract ONLY FIRST token found
          TOKEN=$(echo "$RAW" | grep -o '?hdntl=.*' | head -n 1)

          echo "Extracted TOKEN: $TOKEN"

          # Save to token.txt
          echo "$TOKEN" > token.txt

          # Export to workflow
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Apply Token to All Zee Channels
        run: |
          TOKEN="${{ steps.fetch.outputs.token }}"

          if [ -z "$TOKEN" ]; then
            echo "Token empty â†’ skipping update"
            exit 0
          fi

          echo "Applying token to all Zee5 URLs..."

          # Rewrite all Zee5 lines
          awk -v t="$TOKEN" '
            /z5ak-cmaflive\.zee5\.com/ {
                # remove old ?query
                sub(/\?.*/, "", $0)
                # add fresh token
                print $0 t
                next
            }
            {print}
          ' zee5.m3u > zee5_new.m3u

          mv zee5_new.m3u zee5.m3u

      - name: Commit & Push Updates
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"

          git add zee5.m3u token.txt raw_debug.txt
          git commit -m "Auto-update Zee5 Playlist $(date)" || exit 0
          git push
