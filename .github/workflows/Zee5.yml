name: Update Zee5 m3u Token

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */4 * * *"

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch Zee5 JSON (hidden)
        env:
          JSON_URL: ${{ secrets.ZEE5_JSON_URL }}
        run: |
          if [ -z "$JSON_URL" ]; then
            echo "❌ JSON URL secret missing"
            exit 1
          fi

          curl -fsSL "$JSON_URL" -o data.json

      - name: Extract HDNTL token
        run: |
          TOKEN=$(jq -r '
            .[]
            | .source.url
            | capture("hdntl=(?<t>[^&]+)")
            | "hdntl=\(.t)"
          ' data.json | head -n 1)

          if [ -z "$TOKEN" ]; then
            echo "❌ Token not found"
            exit 1
          fi

          echo "TOKEN=$TOKEN" >> $GITHUB_ENV
          echo "✅ Token extracted"

      - name: Update Zee5.m3u URLs
        run: |
          FILE="Zee5.m3u"

          if [ ! -f "$FILE" ]; then
            echo "❌ Zee5.m3u not found"
            exit 1
          fi

          # Remove old token
          sed -i -E 's/[&?]hdntl=[^&]+//g' "$FILE"

          # Append new token correctly
          sed -i -E "/^https:\/\/z5ak-cmaflive\.zee5\.com/ {
            /\\?/ s/$/&\\&$TOKEN/
            /\\?/! s/$/?$TOKEN/
          }" "$FILE"

          echo "✅ Zee5.m3u updated"

      - name: Commit & push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add Zee5.m3u
          git commit -m "Auto-update Zee5 HDNTL token" || exit 0
          git push
