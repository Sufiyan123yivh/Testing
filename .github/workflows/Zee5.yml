name: Update Zee5 m3u Token & Cookie

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */4 * * *"

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch Zee5 JSON (hidden)
        env:
          JSON_URL: ${{ secrets.ZEE5_JSON_URL }}
        run: |
          if [ -z "$JSON_URL" ]; then
            echo "‚ùå JSON URL secret missing"
            exit 1
          fi
          curl -fsSL "$JSON_URL" -o data.json

      # üîë Extract HDNTL token
      - name: Extract HDNTL token
        run: |
          TOKEN=$(jq -r '
            .[]
            | .source.url
            | capture("hdntl=(?<t>[^&]+)")
            | "hdntl=\(.t)"
          ' data.json | head -n 1)

          if [ -z "$TOKEN" ]; then
            echo "‚ùå Token not found"
            exit 1
          fi

          echo "TOKEN=$TOKEN" >> $GITHUB_ENV
          echo "‚úÖ Token extracted"

      # üç™ Extract Cookie from existing M3U
      - name: Extract Cookie from Zee5.m3u
        run: |
          COOKIE=$(grep -oE 'hdntl=[^&"]+' Zee5.m3u | head -n 1)

          if [ -z "$COOKIE" ]; then
            echo "‚ùå Cookie not found in m3u"
            exit 1
          fi

          echo "COOKIE=$COOKIE" >> $GITHUB_ENV
          echo "‚úÖ Cookie extracted"

      # ‚úèÔ∏è Update M3U (URL + Cookie)
      - name: Update Zee5.m3u URLs & Cookie
        run: |
          FILE="Zee5.m3u"

          # Remove old cookie lines
          sed -i '/#EXTVLCOPT:http-cookie=/d' "$FILE"

          # Remove old hdntl from URLs
          sed -i -E 's/[&?]hdntl=[^&]+//g' "$FILE"

          # Insert cookie BEFORE each Zee5 URL
          sed -i -E "/^https:\/\/z5ak-cmaflive\.zee5\.com/i #EXTVLCOPT:http-cookie=$COOKIE" "$FILE"

          # Append fresh token to URLs
          sed -i -E "/^https:\/\/z5ak-cmaflive\.zee5\.com/ {
            /\?/ s/$/&\\&$TOKEN/
            /\?/! s/$/?$TOKEN/
          }" "$FILE"

          echo "‚úÖ Zee5.m3u updated with token + cookie"

      - name: Commit & push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add Zee5.m3u
          git commit -m "Auto-update Zee5 HDNTL token & cookie" || exit 0
          git push
