name: Update JioTV M3U Token (Safe)

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - run: pip install requests

      - name: Update token safely
        env:
          TOKEN_URL: ${{ secrets.JTV_TOKEN_URL }}
        run: |
          python << 'EOF'
          import requests, re, urllib.parse, shutil, os

          FILE = "jtv.m3u"
          TOKEN_URL = os.environ.get("JSON_SOURCE")

          if not TOKEN_URL:
              raise SystemExit("TOKEN_URL secret not set")

          # Backup for safety
          shutil.copy(FILE, FILE + ".bak")

          # Fetch token
          r = requests.get(TOKEN_URL, timeout=10)
          r.raise_for_status()

          m = re.search(r'__hdnea__=st=\d+~exp=\d+~acl=/\*~hmac=[a-f0-9]+', r.text)
          if not m:
              raise SystemExit("Token not found")

          token = m.group(0)
          token_enc = urllib.parse.quote(token, safe="")

          out = []

          with open(FILE, "r", encoding="utf-8", errors="ignore") as f:
              for line in f:
                  if line.startswith("#EXTHTTP:"):
                      line = re.sub(
                          r'__hdnea__=st=\d+~exp=\d+~acl=/\*~hmac=[a-f0-9]+',
                          token,
                          line
                      )

                  elif line.startswith("http") and "__hdnea__=" in line:
                      line = re.sub(
                          r'__hdnea__=st=\d+~exp=\d+~acl=/\*~hmac=[a-f0-9]+',
                          token,
                          line
                      )
                      line = re.sub(
                          r'xxx=%7Ccookie=__hdnea__%3Dst%3D.*?hmac%3D[a-f0-9]+',
                          'xxx=%7Ccookie=' + token_enc,
                          line
                      )

                  out.append(line)

          with open(FILE, "w", encoding="utf-8") as f:
              f.writelines(out)

          print("Token updated safely")
          EOF

      - name: Commit & push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add jtv.m3u jtv.m3u.bak
          git commit -m "Auto update JioTV hdnea token" || exit 0
          git push
