name: Auto-Update Test.m3u

concurrency:
  group: auto-update-test-m3u
  cancel-in-progress: true

permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */3 * * *'   # every 3 hours

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Generate Test.m3u
        env:
          JSON_URL: ${{ secrets.JSON_SOURCE }}
          FILE_NAME: "Test.m3u"
        run: |
          set -euo pipefail

          # ===== CREATE M3U HEADER WITH EPG =====
          echo '#EXTM3U x-tvg-url="https://tsepg.cf/epg.xml.gz"' > "$FILE_NAME"

          echo "Fetching JSON..."
          JSON=$(curl -fsSL --max-time 30 "$JSON_URL") || {
            echo "Fetch failed"
            exit 1
          }

          echo "$JSON" | jq -r '
            def channels:
              if type=="array" then .
              elif type=="object" then
                if has("channels") then .channels
                elif has("data") then .data
                elif has("list") then .list
                else [.[]]
                end
              else []
              end;

            channels[] as $c |

            ($c.name // $c.title // "Unknown") as $name |
            ($c.tvg_id // $c.tvgId // $c.id // "") as $tvgid |
            ($c.group // $c.category // "Others") as $group |
            ($c.tvg_logo // $c.logo // $c.icon // "") as $logo |
            ($c.drmLicense // $c.license // "") as $lic |
            ($c.drmScheme // $c.drm_scheme // $c.drm // "") as $scheme |
            ($c.cookie // $c.cookies // "") as $cookie |
            ($c.link // $c.url // $c.stream_url // "") as $link |

            select($link != "") |

            "#EXTINF:-1 " +
              (if $tvgid != "" then "tvg-id=\"" + $tvgid + "\" " else "" end) +
              "group-title=\"" + $group + "\" " +
              (if $logo != "" then "tvg-logo=\"" + $logo + "\" " else "" end) +
              "," + $name,

            (if ($scheme=="clearkey") and ($lic | test("^[A-Za-z0-9]+:[A-Za-z0-9]+"))
             then "#KODIPROP:inputstream.adaptive.license_type=clearkey\n#KODIPROP:inputstream.adaptive.license_key=" +
                  ($lic | split(":")[0:2] | join(":"))
             else empty end
            ),

            "#EXTVLCOPT:http-user-agent=plaYtv/7.1.3 (Linux;Android 13) ygx/69.1 ExoPlayerLib/824.0",

            (if $cookie != "" then
              "#EXTHTTP:{\"cookie\":\"" + ($cookie | gsub("\""; "\\\"")) + "\"}"
            else empty end),

            $link + (if ($link | contains("?")) then "&" else "?" end) + $cookie
          ' >> "$FILE_NAME"

          TOTAL=$(grep -c "^#EXTINF" "$FILE_NAME" || echo 0)
          echo "Generated $TOTAL channels"

      - name: Commit & Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Test.m3u
          if git diff --cached --quiet; then
            echo "No changes"
            exit 0
          fi
          git commit -m "Auto-update Test.m3u: $(date -u '+%Y-%m-%d %H:%M')"
          git push origin main
