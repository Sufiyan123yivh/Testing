name: Update JioTV M3U Token

on:
  schedule:
    - cron: "0 */6 * * *"   # every 6 hours
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: pip install requests

      - name: Fetch token and update jtv.m3u
        run: |
          python << 'EOF'
          import requests, re, json, urllib.parse

          TOKEN_URL = "https://jtv.pfy.workers.dev/"
          M3U_FILE = "jtv.m3u"

          # ---------------- Fetch token ----------------
          r = requests.get(TOKEN_URL, timeout=10)
          r.raise_for_status()
          text = r.text

          m = re.search(r"__hdnea__=[^\"'&\s]+", text)
          if not m:
              raise Exception("hdnea token not found")

          token = m.group(0)
          encoded = urllib.parse.quote(token, safe="")

          print("New token:", token)

          # ---------------- Read M3U ----------------
          with open(M3U_FILE, "r", encoding="utf-8", errors="ignore") as f:
              data = f.read()

          # 1️⃣ Update EXTHTTP cookie JSON
          data = re.sub(
              r'(#EXTHTTP:\{"cookie":"?)__hdnea__=[^"]+',
              r'\1' + token,
              data
          )

          # 2️⃣ Update URL __hdnea__ param
          data = re.sub(
              r'__hdnea__=[^&\s]+',
              token,
              data
          )

          # 3️⃣ Update encoded cookie in xxx=%7Ccookie=
          data = re.sub(
              r'xxx=%7Ccookie=__hdnea__%3D[^&\s]+',
              'xxx=%7Ccookie=' + encoded,
              data
          )

          # ---------------- Write back ----------------
          with open(M3U_FILE, "w", encoding="utf-8") as f:
              f.write(data)

          print("jtv.m3u updated successfully")
          EOF

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add jtv.m3u
          git commit -m "Auto update JioTV hdnea token" || exit 0
          git push
