name: Update Sony m3u Token

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */4 * * *"

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch Sony source m3u (hidden)
        env:
          SONY_URL: ${{ secrets.SONY_M3U_URL }}
        run: |
          if [ -z "$SONY_URL" ]; then
            echo "❌ SONY_M3U_URL secret missing"
            exit 1
          fi

          curl -fsSL "$SONY_URL" -o sony_source.m3u

      - name: Extract HDNEA token
        run: |
          TOKEN=$(grep -oE 'hdnea=[^&"]+' sony_source.m3u | head -n 1)

          if [ -z "$TOKEN" ]; then
            echo "❌ hdnea token not found"
            exit 1
          fi

          echo "TOKEN=$TOKEN" >> $GITHUB_ENV
          echo "✅ HDNEA token extracted"

      - name: Update Sony.m3u
        run: |
          FILE="Sony.m3u"

          if [ ! -f "$FILE" ]; then
            echo "❌ Sony.m3u not found"
            exit 1
          fi

          # 1️⃣ Remove old hdnea tokens
          sed -i -E 's/[&?]hdnea=[^&]+//g' "$FILE"

          # 2️⃣ Fix broken query symbols
          sed -i -E 's/\?&/?/g; s/[?&]$//g' "$FILE"

          # 3️⃣ Append new token safely (NO sed replacement)
          while IFS= read -r line; do
            if [[ "$line" == https://dishmt.slivcdn.com/* ]]; then
              if [[ "$line" == *\?* ]]; then
                echo "${line}&${TOKEN}"
              else
                echo "${line}?${TOKEN}"
              fi
            else
              echo "$line"
            fi
          done < "$FILE" > "$FILE.tmp"

          mv "$FILE.tmp" "$FILE"

          echo "✅ Sony.m3u updated"

      - name: Commit & push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add Sony.m3u
          git commit -m "Auto-update Sony HDNEA token" || exit 0
          git push
