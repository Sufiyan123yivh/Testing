name: Update Sony m3u Token

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */4 * * *"

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch Sony playlist (hidden)
        env:
          SONY_URL: ${{ secrets.SONY_M3U_URL }}
        run: |
          if [ -z "$SONY_URL" ]; then
            echo "❌ SONY_M3U_URL secret missing"
            exit 1
          fi

          curl -fsSL "$SONY_URL" -o sony_source.m3u

      - name: Extract Sony HDNTL token
        run: |
          TOKEN=$(grep -oE 'hdntl=[^&"]+' sony_source.m3u | head -n 1)

          if [ -z "$TOKEN" ]; then
            echo "❌ HDNTL token not found"
            exit 1
          fi

          echo "TOKEN=$TOKEN" >> $GITHUB_ENV
          echo "✅ Sony token extracted"

      - name: Update Sony.m3u
        run: |
          FILE="Sony.m3u"

          if [ ! -f "$FILE" ]; then
            echo "❌ Sony.m3u not found"
            exit 1
          fi

          # Remove old hdntl tokens
          sed -i -E 's/hdntl=[^&"]+//g' "$FILE"

          # Clean dangling ? or &
          sed -i -E 's/\?&/?/g; s/[?&]$//g' "$FILE"

          # Insert new token correctly
          sed -i -E "s/(\?[^#\"]*)/\1\&$TOKEN/; t; s/$/?$TOKEN/" "$FILE"

          echo "✅ Sony.m3u updated"

      - name: Commit & push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add Sony.m3u
          git commit -m "Auto-update Sony HDNTL token" || exit 0
          git push
