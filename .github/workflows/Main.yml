name: Update Zee5 Playlist

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Run Python Script to Fetch Token
        id: fetch
        shell: bash
        run: |
          python3 fetch_zee5.py | tee output.txt
          
          # Extract token from Python output
          token_line=$(grep "token=" output.txt || true)
          token_value="${token_line#token=}"

          echo "token=$token_value" >> "$GITHUB_OUTPUT"

      - name: Apply Token to Playlist
        shell: bash
        run: |
          TOKEN="${{ steps.fetch.outputs.token }}"

          if [ -z "$TOKEN" ]; then
            echo "Token missing â€” skipping update."
            exit 0
          fi

          awk -v t="$TOKEN" '
            /z5ak-cmaflive\.zee5\.com/ {
              sub(/\?.*/, "", $0)
              print $0 t
              next
            }
            { print }
          ' zee5.m3u > zee5_new.m3u

          mv zee5_new.m3u zee5.m3u

      - name: Commit Updates
        shell: bash
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"

          git add zee5.m3u token.txt debug.txt output.txt
          git commit -m "Auto-update Zee5 token $(date)" || exit 0
          git push
