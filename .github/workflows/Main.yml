name: Update Zee5 Playlist

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      # Step 1 - Checkout Repo
      - name: Checkout Repo
        uses: actions/checkout@v4

      # Step 2 - Fetch URL using Python (NO CURL)
      - name: Fetch Zee5 URL using Python
        id: fetch
        shell: python3
        run: |
          import requests

          debug = open("debug.txt", "w")

          url = "http://mini.allinonereborn.fun/zee-paid/index.php?id=0-9-zeebangla"
          debug.write("Opening URL: " + url + "\n\n")

          # Make request like browser
          r = requests.get(url, allow_redirects=True, headers={
              "User-Agent": "Mozilla/5.0"
          })

          # Log redirect history
          debug.write("=== Redirect History ===\n")
          for step in r.history:
              debug.write(f"{step.url}  -->  {step.status_code}\n")

          # Final URL
          debug.write("\n=== FINAL URL ===\n")
          debug.write(r.url + "\n")

          FINAL_URL = r.url

          # Extract token
          TOKEN = ""
          if "?" in FINAL_URL:
              TOKEN = "?" + FINAL_URL.split("?", 1)[1]

          debug.write("\n=== TOKEN EXTRACTED ===\n")
          debug.write(TOKEN + "\n")

          with open("token.txt", "w") as f:
              f.write(TOKEN)

          # Escape token for GitHub output
          esc = TOKEN.replace("%", "%25").replace("\n", "%0A").replace("\r", "%0D")

          print(f"token={esc}")

      # Step 3 — Apply Token to M3U File
      - name: Apply Token to All Zee5 Channels
        shell: bash
        run: |
          TOKEN="${{ steps.fetch.outputs.token }}"

          if [ -z "$TOKEN" ]; then
            echo "Token missing, skipping update."
            exit 0
          fi

          echo "Applying Zee5 token to zee5.m3u..."

          awk -v t="$TOKEN" '
            /z5ak-cmaflive\.zee5\.com/ {
              sub(/\?.*/, "", $0)   # remove old token
              print $0 t
              next
            }
            { print }
          ' zee5.m3u > zee5_new.m3u

          mv zee5_new.m3u zee5.m3u

      # Step 4 — Commit and Push Changes
      - name: Commit Updates
        shell: bash
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"

          git add zee5.m3u token.txt debug.txt
          git commit -m "Auto-updated Zee5 token & playlist $(date)" || exit 0
          git push
